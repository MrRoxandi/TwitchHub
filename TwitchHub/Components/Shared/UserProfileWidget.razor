@using TwitchLib.Api
@using TwitchLib.Api.Helix.Models.Users
@using TwitchHub.Services.Backends
@inject TwitchAPI TwitchApi
@inject TwitchConfigurator TwitchConfigurator
@inject NavigationManager NavManager

<!-- Обертка такая же, как была в Layout, чтобы сохранить стиль -->
<div class="mt-auto p-4 border-t border-solid" style="border-color: #27272a;">

    @if (_isLoading)
    {
        <!-- Скелетон загрузки -->
        <div class="d-flex align-center gap-3">
            <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" />
            <div style="width: 100px;">
                <MudSkeleton Width="100%" Height="14px" />
                <MudSkeleton Width="60%" Height="10px" Class="mt-1" />
            </div>
        </div>
    }
    else if (!_isAuthenticated)
    {
        <!-- Состояние: НЕ АВТОРИЗОВАН -->
        <MudButton Variant="Variant.Filled"
                   FullWidth="true"
                   Style="background-color: #9146FF; color: white;"
                   StartIcon="@CustomIcons.TwitchIcon"
                   OnClick="Login">
            Войти
        </MudButton>
    }
    else
    {
        <!-- Состояние: АВТОРИЗОВАН -->
        <div class="d-flex align-center gap-3">
            <!-- Аватарка -->
            <MudBadge Color="Color.Error" Overlap="true" Bordered="true" Visible="@_isLive" Dot="true">
                <MudAvatar Size="Size.Medium" Class="ring-2 ring-primary">
                    <MudImage Src="@_profileImageUrl"/>
                </MudAvatar>
            </MudBadge>

            <div style="min-width: 0; flex-grow: 1;">
                <MudText Typo="Typo.body2" Style="font-weight: 600;" Class="text-truncate">
                    @_displayName
                </MudText>

                <div class="d-flex align-center gap-1">
                    @if (_isLive)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Style="width: 8px; height: 8px; color: #ef4444;" />
                        <MudText Typo="Typo.caption" Style="color: #ef4444; font-weight: 700;">LIVE (@_viewerCount)</MudText>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Style="width: 8px; height: 8px; color: #71717a;" />
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Offline</MudText>
                    }
                </div>
            </div>

            <MudTooltip Text="Выйти">
                <MudIconButton Icon="@Icons.Material.Filled.Logout"
                               Size="Size.Small"
                               Class="ml-auto"
                               Color="Color.Error"
                               Variant="Variant.Text"
                               OnClick="Logout" />
            </MudTooltip>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isAuthenticated = false;

    // Данные пользователя
    private string? _displayName;
    private string? _profileImageUrl;
    private string? _userId;

    // Статус стрима
    private bool _isLive = false;
    private int _viewerCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            // 1. Проверяем наличие токена
            var token = TwitchApi.Settings.AccessToken;
            if (string.IsNullOrEmpty(token))
            {
                _isAuthenticated = false;
                _isLoading = false;
                return;
            }

            // 2. Получаем данные пользователя
            var usersResponse = await TwitchApi.Helix.Users.GetUsersAsync();
            var user = usersResponse.Users.FirstOrDefault();

            if (user != null)
            {
                _isAuthenticated = true;
                _displayName = user.DisplayName;
                _profileImageUrl = user.ProfileImageUrl;
                _userId = user.Id;

                // 3. Проверяем статус стрима
                var streamsResponse = await TwitchApi.Helix.Streams.GetStreamsAsync(userIds: new List<string> { user.Id });
                var stream = streamsResponse.Streams.FirstOrDefault();

                if (stream != null)
                {
                    _isLive = true;
                    _viewerCount = stream.ViewerCount;
                }
                else
                {
                    _isLive = false;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user profile: {ex.Message}");
            _isAuthenticated = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged(); // Принудительно обновляем UI
        }
    }

    private void Login()
    {
        // Используем метод из конфигуратора для получения ссылки
        var url = TwitchConfigurator.GetAuthorizationLink();
        NavManager.NavigateTo(url, forceLoad: true);
    }

    private void Logout()
    {
        // Очищаем токен
        TwitchApi.Settings.AccessToken = null;

        // Перезагружаем страницу, чтобы сбросить состояние
        NavManager.NavigateTo("/", forceLoad: true);
    }
}